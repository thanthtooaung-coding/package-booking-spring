name: Build and Deploy to GCP

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_ID: ace-fiber-477808-u3
  ZONE: us-central1-a
  INSTANCE_NAME: instance-20251110-085701

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Find and copy JAR file
        id: find-jar
        run: |
          JAR_FILE=$(find target -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
          JAR_NAME=$(basename "$JAR_FILE")
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "JAR_NAME=$JAR_NAME" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_NAME"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Copy JAR to GCP instance
        run: |
          gcloud compute scp ${{ steps.find-jar.outputs.JAR_FILE }} ${{ env.INSTANCE_NAME }}:~/ \
            --zone=${{ env.ZONE }} \
            --project=${{ env.PROJECT_ID }}
          echo "Deployed ${{ steps.find-jar.outputs.JAR_NAME }} to GCP instance"

